node('master') {
  def dockerTool = tool name: 'docker', type: 'org.jenkinsci.plugins.docker.commons.tools.DockerTool'
  def nodeTool = tool name: 'node', type: 'nodejs'
  
  withEnv(["DOCKER=${dockerTool}/bin", "NODEJS=${nodeTool}/bin"]) {
    stage('Cloning repository.') {
      checkout scm
    }

    stage('Installing dependencies.') {
      nodejs(nodeJSInstallationName: 'node') {
        nodeSh 'yarn'
      }
    }

    stage('Running unit tests') {
      nodejs(nodeJSInstallationName: 'node') {
        nodeSh "yarn test"
       }
    }

    stage('Running unit tests') {
      dockerSh "docker run --name hello hello-world"
    }

    stage('Running unit tests') {
      dockerSh "docker stop hello"
    }
    
    stage("Docker Purge") {
      steps {
        dockerSh "docker image prune -fa"
        deleteDir()
      }
    }

  }
}

def dockerSh(args) {
  sh "${DOCKER}/${args}"
}
def nodeSh(args) {
  sh "${NODEJS}/${args}"
}	
