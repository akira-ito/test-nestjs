node('master') {
  def dockerTool = tool name: 'docker', type: 'org.jenkinsci.plugins.docker.commons.tools.DockerTool'
  def nodeTool = tool name: 'node', type: 'nodejs'
  def dockerImage
  def registry = "edsonakiraito/sip"
  
  withEnv(["DOCKER=${dockerTool}/bin", "NODEJS=${nodeTool}/bin"]) {
    stage('Cloning repository.') {
      checkout scm
    }

    stage('Installing dependencies.') {
      nodejs(nodeJSInstallationName: 'node') {
        nodeSh 'yarn'
      }
    }

    stage('Running unit tests') {
      nodejs(nodeJSInstallationName: 'node') {
        nodeSh "yarn test"
       }
    }
    
    stage('Build image') {
        dockerImage = docker.build registry+":$BUILD_NUMBER"
    }

    stage('Deploy our image') { 
        docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-credentials') {
            dockerImage.push("${env.BUILD_NUMBER}")
            dockerImage.push("latest")
        }
    } 
    
    stage("Docker Purge") {
      steps {
        dockerSh "docker image prune -fa"
        dockerSh "docker rmi $registry:$BUILD_NUMBER" 
        deleteDir()
      }
    }

  }
}

def dockerSh(args) {
  sh "${DOCKER}/${args}"
}
def nodeSh(args) {
  sh "${NODEJS}/${args}"
}	
